filt_if="<%= @bridge_interface %>"

inband_if="<%= @inband_interface %>"  # In-band tunnel to cloud
inband_ip="<%= @peernode_inband_ip %>"

outofband_if="<%= @outofband_interface %>"  # Out-of-band tunnel to cloud

rfc1918="{ 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 }"

multicast="{ 224.0.0.0/3 }"

### the mock internet (RFC1918 addr simulating a non-RFC1918)
mock_net="{ 10.8.9.0/24 }"

### the cloud's 'public' address(es)
cloud_net="{ <%= @peernode_public_ip %>/32 }"

# no filtering on loopback, vagrant-net, or NFS mount net
set skip on lo0
set skip on em0  # Vagrant
set skip on em1  # NFS
set skip on $outofband_if  # AWN in-band

# default allow
pass all

# quick skip for outbound traffic to cloud
pass quick on $outofband_if all
pass quick on $filt_if proto {tcp,udp} from any port 67:68 to any port 67:68  # DHCP/BOOTP
pass quick on $filt_if proto {tcp,udp} from any port 69 to any port 69        # TFTP

# route all traffic to the cloud...
pass out on $filt_if route-to ($inband_if $inband_ip) all
pass in  on $filt_if route-to ($inband_if $inband_ip) all

# ...except for RFC1918 addresses...
pass out on $filt_if fastroute from $rfc1918 to $rfc1918
pass in  on $filt_if fastroute from $rfc1918 to $rfc1918

# ...except for multicast addresses...
pass out on $filt_if fastroute from any to $multicast
pass in  on $filt_if fastroute from $multicast to any

# ...except for mock_net (which goes to the cloud, too)...
pass out on $filt_if route-to ($inband_if $inband_ip) from any to $mock_net
pass in  on $filt_if route-to ($inband_if $inband_ip) from $mock_net to any

# ...except for cloud_net (which is the outer address for the tunnel)...
pass out on $filt_if fastroute from any to $cloud_net
pass in  on $filt_if fastroute from $cloud_net to any

# don't tunnel NTP (for now)
pass out on $filt_if fastroute proto udp from any to any port ntp
pass in  on $filt_if fastroute proto udp from any port ntp to any

# return traffic from cloud : requires net.inet.ip.forwarding=1
pass in  on $inband_if route-to $filt_if from any to $filt_if:network
